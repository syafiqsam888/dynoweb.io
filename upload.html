<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DynoWeb Upload by Link</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            border-color: #4CAF50;
            outline: none;
        }
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .upload-results {
            margin-top: 20px;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .result-success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .result-error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Upload Files by Link</h1>
        
        <div class="upload-section">
            <label for="urlInput">Enter URLs (one per line):</label>
            <textarea id="urlInput" placeholder="https://example.com/file1.pdf&#10;https://example.com/file2.mp4&#10;https://cdn.example.com/media/video%20file.mp4"></textarea>
        </div>
        
        <div class="upload-section">
            <label for="folderSelect">Select Dropbox Folder:</label>
            <select id="folderSelect">
                <option value="/">Root Folder</option>
                <option value="/uploads">Uploads</option>
                <option value="/documents">Documents</option>
                <option value="/media">Media</option>
            </select>
        </div>
        
        <button id="uploadBtn" onclick="handleUploadByLink()">Start Upload</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="margin-top: 10px; text-align: center;">0% complete</div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="upload-results" id="uploadResults"></div>
    </div>

    <script>
        // Configuration
        const DROPBOX_ACCESS_TOKEN = 'YOUR_DROPBOX_ACCESS_TOKEN'; // This should be set by the user
        const MAX_FILE_SIZE = 150 * 1024 * 1024; // 150MB limit for single uploads
        
        // Debug logging function
        function debugLog(message, data = null) {
            console.log(`[Upload Debug] ${message}`, data || '');
        }
        
        // Improved URL validation using URL constructor
        function validateUrl(urlString) {
            try {
                const url = new URL(urlString.trim());
                // Check if protocol is http or https
                if (url.protocol !== 'http:' && url.protocol !== 'https:') {
                    return { valid: false, error: 'URL must use HTTP or HTTPS protocol' };
                }
                // Check if hostname exists
                if (!url.hostname) {
                    return { valid: false, error: 'URL must have a valid hostname' };
                }
                return { valid: true, url: url };
            } catch (error) {
                return { valid: false, error: 'Invalid URL format' };
            }
        }
        
        // Robust filename extraction function
        function extractFilename(url) {
            try {
                debugLog('Extracting filename from URL', url.toString());
                
                // Get pathname without query parameters
                let pathname = url.pathname;
                
                // Decode URL-encoded characters
                pathname = decodeURIComponent(pathname);
                
                // Extract filename from path
                let filename = pathname.split('/').pop();
                
                // If no filename or just a path separator, try to generate one
                if (!filename || filename === '') {
                    // Use hostname and timestamp as fallback
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    filename = `${url.hostname}-${timestamp}.bin`;
                }
                
                // If filename has no extension, try to determine from URL or use .bin
                if (!filename.includes('.')) {
                    // Check if URL suggests a file type
                    const urlStr = url.toString().toLowerCase();
                    if (urlStr.includes('mp4') || urlStr.includes('video')) {
                        filename += '.mp4';
                    } else if (urlStr.includes('pdf') || urlStr.includes('document')) {
                        filename += '.pdf';
                    } else if (urlStr.includes('jpg') || urlStr.includes('jpeg') || urlStr.includes('image')) {
                        filename += '.jpg';
                    } else if (urlStr.includes('png')) {
                        filename += '.png';
                    } else {
                        filename += '.bin'; // Generic binary file
                    }
                }
                
                // Clean filename of invalid characters
                filename = filename.replace(/[<>:"/\\|?*]/g, '_');
                
                // Ensure filename isn't too long
                if (filename.length > 255) {
                    const extension = filename.substring(filename.lastIndexOf('.'));
                    filename = filename.substring(0, 255 - extension.length) + extension;
                }
                
                debugLog('Extracted filename', filename);
                return filename;
            } catch (error) {
                debugLog('Error extracting filename', error);
                // Fallback filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                return `download-${timestamp}.bin`;
            }
        }
        
        // Download file from URL
        async function downloadFile(url) {
            debugLog('Starting download', url.toString());
            
            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentLength = response.headers.get('content-length');
                if (contentLength && parseInt(contentLength) > MAX_FILE_SIZE) {
                    throw new Error(`File too large: ${Math.round(parseInt(contentLength) / 1024 / 1024)}MB (max ${Math.round(MAX_FILE_SIZE / 1024 / 1024)}MB)`);
                }
                
                const blob = await response.blob();
                debugLog('Download completed', `Size: ${blob.size} bytes`);
                
                return blob;
            } catch (error) {
                debugLog('Download failed', error);
                throw new Error(`Download failed: ${error.message}`);
            }
        }
        
        // Upload file to Dropbox
        async function uploadToDropbox(filename, fileBlob, folder) {
            debugLog('Starting Dropbox upload', { filename, folder, size: fileBlob.size });
            
            if (!DROPBOX_ACCESS_TOKEN || DROPBOX_ACCESS_TOKEN === 'YOUR_DROPBOX_ACCESS_TOKEN') {
                throw new Error('Dropbox access token not configured');
            }
            
            const dropboxPath = folder === '/' ? `/${filename}` : `${folder}/${filename}`;
            
            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DROPBOX_ACCESS_TOKEN}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: dropboxPath,
                            mode: 'add',
                            autorename: true
                        })
                    },
                    body: fileBlob
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    debugLog('Dropbox API error', { status: response.status, error: errorText });
                    
                    let errorMessage = `Dropbox API error (${response.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error_summary) {
                            errorMessage = errorData.error_summary;
                        }
                    } catch (e) {
                        // Use the raw error text if JSON parsing fails
                        if (errorText) {
                            errorMessage = errorText;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                debugLog('Dropbox upload successful', result);
                
                return result;
            } catch (error) {
                debugLog('Dropbox upload failed', error);
                throw new Error(`Dropbox upload failed: ${error.message}`);
            }
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            debugLog(`Status: ${type}`, message);
        }
        
        // Update progress
        function updateProgress(completed, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const percentage = Math.round((completed / total) * 100);
            
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}% complete (${completed}/${total})`;
        }
        
        // Add result item
        function addResult(url, success, message) {
            const resultsContainer = document.getElementById('uploadResults');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item result-${success ? 'success' : 'error'}`;
            resultItem.innerHTML = `
                <strong>${url}</strong><br>
                ${message}
            `;
            resultsContainer.appendChild(resultItem);
        }
        
        // Main upload handler
        async function handleUploadByLink() {
            debugLog('Starting upload by link process');
            
            const urlInput = document.getElementById('urlInput');
            const folderSelect = document.getElementById('folderSelect');
            const uploadBtn = document.getElementById('uploadBtn');
            const resultsContainer = document.getElementById('uploadResults');
            
            // Clear previous results
            resultsContainer.innerHTML = '';
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            
            // Get URLs from input
            const urls = urlInput.value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                showStatus('Please enter at least one URL', 'error');
                return;
            }
            
            // Validate URLs
            const validatedUrls = [];
            for (const urlString of urls) {
                const validation = validateUrl(urlString);
                if (validation.valid) {
                    validatedUrls.push(validation.url);
                } else {
                    addResult(urlString, false, `Invalid URL: ${validation.error}`);
                }
            }
            
            if (validatedUrls.length === 0) {
                showStatus('No valid URLs found. Please check your URLs and try again.', 'error');
                return;
            }
            
            debugLog(`Processing ${validatedUrls.length} valid URLs out of ${urls.length} total`);
            
            // Disable upload button
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            const selectedFolder = folderSelect.value;
            let completedCount = 0;
            let successCount = 0;
            
            showStatus('Starting uploads...', 'info');
            updateProgress(0, validatedUrls.length);
            
            // Process URLs sequentially to avoid overwhelming the APIs
            for (const url of validatedUrls) {
                try {
                    debugLog('Processing URL', url.toString());
                    showStatus(`Downloading: ${url.hostname}...`, 'info');
                    
                    // Extract filename
                    const filename = extractFilename(url);
                    
                    // Download file
                    const fileBlob = await downloadFile(url);
                    
                    showStatus(`Uploading to Dropbox: ${filename}...`, 'info');
                    
                    // Upload to Dropbox
                    const uploadResult = await uploadToDropbox(filename, fileBlob, selectedFolder);
                    
                    addResult(url.toString(), true, `Successfully uploaded as: ${uploadResult.name}`);
                    successCount++;
                    
                } catch (error) {
                    debugLog('Upload failed for URL', { url: url.toString(), error: error.message });
                    addResult(url.toString(), false, error.message);
                }
                
                completedCount++;
                updateProgress(completedCount, validatedUrls.length);
                
                // Add small delay between uploads
                if (completedCount < validatedUrls.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Final status
            if (successCount === 0) {
                showStatus('All uploads failed. Please check your URLs and try again.', 'error');
            } else if (successCount === validatedUrls.length) {
                showStatus(`All ${successCount} files uploaded successfully!`, 'success');
            } else {
                showStatus(`${successCount} of ${validatedUrls.length} files uploaded successfully.`, 'info');
            }
            
            // Re-enable upload button
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Start Upload';
            
            debugLog('Upload process completed', { total: validatedUrls.length, successful: successCount });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Application initialized');
            
            // Check if Dropbox token is configured
            if (!DROPBOX_ACCESS_TOKEN || DROPBOX_ACCESS_TOKEN === 'YOUR_DROPBOX_ACCESS_TOKEN') {
                showStatus('Warning: Dropbox access token not configured. Please set your access token in the script.', 'error');
            }
        });
    </script>
</body>
</html>